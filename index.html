<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>אילן יוחסין – דמו אינטראקטיבי</title>
  <!-- Cytoscape & Dagre for hierarchical layouts -->
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
  <!-- Hebrew-friendly font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a;         /* slate-900 */
      --panel:#111827;      /* gray-900 */
      --card:#1f2937;       /* gray-800 */
      --text:#e5e7eb;       /* gray-200 */
      --muted:#94a3b8;      /* slate-400 */
      --accent:#22d3ee;     /* cyan-400 */
      --accent-2:#f472b6;   /* pink-400 */
      --edge:#334155;       /* slate-700 */
      --highlight:#fde047;  /* yellow-400 */
      --male:#60a5fa;       /* blue-400 */
      --female:#f472b6;     /* pink-400 */
      --union:#10b981;      /* emerald-500 */
    }
    /* Light theme overrides */
    :root.theme-light{
      --bg:#f8fafc;         /* slate-50 */
      --panel:#ffffff;      /* white */
      --card:#f1f5f9;       /* slate-100 */
      --text:#0f172a;       /* slate-900 */
      --muted:#475569;      /* slate-600 */
      --accent:#06b6d4;     /* cyan-500 */
      --accent-2:#ec4899;   /* pink-500 */
      --edge:#94a3b8;       /* slate-400 */
      --highlight:#ca8a04;  /* yellow-600 */
      --male:#3b82f6;       /* blue-500 */
      --female:#ec4899;     /* pink-500 */
      --union:#059669;      /* emerald-600 */
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Heebo, system-ui, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans", sans-serif;
      background:linear-gradient(180deg, #0b1220, #0f172a 35%, #0b1220 100%);
      color:var(--text);
    }
    :root.theme-light body{ background:linear-gradient(180deg, #e2e8f0, #f8fafc 40%, #e2e8f0 100%); }
    header{
      padding:12px 16px; background:transparent; position:sticky; top:0; z-index:5;
      backdrop-filter:saturate(140%) blur(6px);
    }
    .toolbar{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      max-width:1100px; margin:0 auto;
    }
    .toolbar h1{font-size:18px; margin:0; font-weight:700; letter-spacing:0.3px}
    .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .controls select, .controls button, .controls input{
      background:var(--card); color:var(--text); border:1px solid #374151; padding:8px 10px; border-radius:10px; min-height:40px;
    }
    .controls button{cursor:pointer; border:1px solid #475569}
    .controls .spacer{width:8px; height:1px}
    .wrap{
      max-width:1100px; margin:0 auto; padding:8px 12px 16px; display:grid; grid-template-columns:1fr; gap:12px;
    }
    #cy{
      width:100%; height:70vh; background:#0b1220; border:1px solid #1f2937; border-radius:14px;
    }
    :root.theme-light #cy{ background:#ffffff; border-color:#cbd5e1 }
    .legend{display:flex; gap:12px; align-items:center; flex-wrap:wrap; font-size:13px; color:var(--muted)}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:var(--card); border:1px solid #334155; border-radius:999px}
    .dot{width:10px; height:10px; border-radius:50%}
    /* Modal */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:50}
    .modal.show{display:flex}
    .modal-backdrop{position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(2px)}
    .modal-card{
      position:relative; width:min(820px,95vw); background:var(--panel);
      border:1px solid #334155; border-radius:18px; overflow:hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      transform: translateY(6px) scale(.98); opacity:.98; transition: transform .2s ease, opacity .2s ease;
      max-height:90vh; display:flex; flex-direction:column;
    }
    .modal.show .modal-card{ transform: translateY(0) scale(1); opacity:1 }
    .modal-content{ padding:22px; overflow:auto; display:flex; gap:24px; align-items:flex-start }
    .profile-photo{
      width:260px; height:260px; object-fit:cover; border-radius:16px; display:block; margin:0;
      border:1px solid #374151; box-shadow: 0 10px 30px rgba(0,0,0,.45);
      flex:0 0 260px;
    }
    .text-col{ flex:1 1 auto; min-width:0 }
    .title{ text-align:right }
    .title h3{ margin:0 0 8px 0; font-size:26px; letter-spacing:.2px }
    .meta{ font-size:13.5px; color:#94a3b8; margin-bottom:12px; text-align:right }
    .badges{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start; margin:6px 0 16px }
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; font-size:12px; color:var(--text);
      background:var(--card); border:1px solid #334155; border-radius:999px;
    }
    .chip.dot::before{ content:""; width:8px; height:8px; border-radius:50%; background: var(--chip, var(--accent)); display:inline-block }
  .bio-text{ margin:0; color:#e5e7eb; line-height:1.95; font-size:17px; max-width:62ch; white-space:pre-wrap }
    .close-btn{
      position:absolute; top:10px; left:10px; width:36px; height:36px; border-radius:999px;
      background:#0b1220; border:1px solid #374151; color:#e5e7eb; cursor:pointer; display:grid; place-items:center;
      box-shadow: 0 2px 10px rgba(0,0,0,.35);
    }

  /* (Cytoscape classes handle dimming; DOM CSS not needed) */

    /* Cytoscape theme */
    @media (max-width:700px){
      #cy{height:68vh}
      .modal-content{ flex-direction:column; }
      .profile-photo{ margin:6px auto 8px; width:220px; height:220px; flex:0 0 auto }
      .title, .meta{ text-align:center }
      .badges{ justify-content:center }
      .bio-text{ margin-inline:auto }
    }
  </style>
</head>
<body>
  <header>
    <div class="toolbar">
      <h1>אילן יוחסין – דוגמה</h1>
      <div class="controls">
        <label for="personA">מסלול בין:</label>
        <select id="personA"></select>
        <span>↔︎</span>
        <select id="personB"></select>
        <button id="btnPath">הדגש מסלול</button>
        <button id="btnClear">נקה</button>
        <button id="btnFit">התאם למסך</button>
        <span class="spacer"></span>
        <button id="btnZoomIn" title="זום פנימה">＋</button>
        <button id="btnZoomOut" title="זום החוצה">－</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="cy" role="application" aria-label="ממשק אילן יוחסין אינטראקטיבי"></div>
  </main>

  <!-- Modal for person info -->
  <div class="modal" id="personModal" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-card" role="dialog" aria-modal="true">
      <button class="close-btn" id="closeModal" aria-label="סגור">✕</button>
      <div class="modal-content">
        <img class="profile-photo" id="modalPhoto" alt="תמונת פרופיל" src="" />
        <div class="text-col">
          <div class="title">
            <h3 id="modalName"></h3>
            <div id="modalMeta" class="meta"></div>
          </div>
          <div id="modalBadges" class="badges"></div>
          <p id="modalBio" class="bio-text"></p>
        </div>
      </div>
    </div>
  </div>
  

  <script>
    // ==========================
    // Demo JSON data structure
    // ==========================
    // כל אובייקט מייצג אדם יחיד.
    // id: מזהה ייחודי | name, gender ('M'/'F'), birth, death?, photo, bio
    // parents: [id,id] | spouse: id | children: [id,id,...]
    const familyData = [
      { id:"p1", name:"יוסף (1918–1999)", gender:"M", birth:1918, death:1999, photo:"https://picsum.photos/seed/y1/300/300", bio:"עלה מפולין, נגר אומן ואב למשפחה גדולה.", spouse:"p2", parents:[], children:["p3","p4"] },
      { id:"p2", name:"שרה (1922–2005)", gender:"F", birth:1922, death:2005, photo:"https://picsum.photos/seed/s1/300/300", bio:"מורה לספרות, אהבה צילום וטיולים.", spouse:"p1", parents:[], children:["p3","p4"] },

      { id:"p3", name:"דוד (1948–)", gender:"M", birth:1948, photo:"https://picsum.photos/seed/d1/300/300", bio:"מהנדס חשמל, מנגן בחליל צד.", spouse:"p5", parents:["p1","p2"], children:["p6","p7","p8"] },
      { id:"p4", name:"נעמי (1952–)", gender:"F", birth:1952, photo:"https://picsum.photos/seed/n1/300/300", bio:"ספרנית, אוספת דגמי מיניאטורות.", spouse:"p9", parents:["p1","p2"], children:["p10"] },

      { id:"p5", name:"רחל (1951–)", gender:"F", birth:1951, photo:"https://picsum.photos/seed/r1/300/300", bio:"אדריכלית נוף, אוהבת גינון.", spouse:"p3", parents:[], children:["p6","p7","p8"] },
      { id:"p9", name:"אורי (1950–)", gender:"M", birth:1950, photo:"https://picsum.photos/seed/u1/300/300", bio:"מורה למתמטיקה וחובב שחמט.", spouse:"p4", parents:[], children:["p10"] },

      { id:"p6", name:"יעל (1976–)", gender:"F", birth:1976, photo:"https://picsum.photos/seed/y2/300/300", bio:"מאמנת כושר ורצה מרתונים. גדשג דשג דשג שדג דגשד גדש גשד גדשג שדג שדג שדג שדג שדג דשג שדג שדג שד גשדג שדג שדג שדג שדג שדגדגדגדג דג דג דג דג דג דשגש ד גדגש דגגשדגדגדשגדשג שדג שדג שדג שג", spouse:"p11", parents:["p3","p5"], children:["p12","p13"] },
      { id:"p7", name:"איתן (1979–)", gender:"M", birth:1979, photo:"https://picsum.photos/seed/e1/300/300", bio:"מפתח תוכנה, מנגן בבס.", spouse:"p14", parents:["p3","p5"], children:["p15"] },
      { id:"p8", name:"מאיה (1984–)", gender:"F", birth:1984, photo:"https://picsum.photos/seed/m1/300/300", bio:"רופאה ילדים, חובבת צילום.", spouse:null, parents:["p3","p5"], children:[] },
      { id:"p10", name:"תמר (1978–)", gender:"F", birth:1978, photo:"https://picsum.photos/seed/t1/300/300", bio:"מעצבת פנים.", spouse:"p16", parents:["p4","p9"], children:["p17","p18"] },

      { id:"p11", name:"גלעד (1975–)", gender:"M", birth:1975, photo:"https://picsum.photos/seed/g1/300/300", bio:"יזם חברתי.", spouse:"p6", parents:[], children:["p12","p13"] },
      { id:"p14", name:"קרן (1981–)", gender:"F", birth:1981, photo:"https://picsum.photos/seed/k1/300/300", bio:"יועצת קריירה.", spouse:"p7", parents:[], children:["p15"] },
      { id:"p16", name:"יוני (1977–)", gender:"M", birth:1977, photo:"https://picsum.photos/seed/y3/300/300", bio:"מתכנת ומוזיקאי.", spouse:"p10", parents:[], children:["p17","p18"] },

      { id:"p12", name:"ליאן (2005–)", gender:"F", birth:2005, photo:"https://picsum.photos/seed/l1/300/300", bio:"סטודנטית לביולוגיה.", parents:["p6","p11"], spouse:null, children:[] },
      { id:"p13", name:"אור (2009–)", gender:"M", birth:2009, photo:"https://picsum.photos/seed/o1/300/300", bio:"שחקן כדורסל נלהב.", parents:["p6","p11"], spouse:null, children:[] },
      { id:"p15", name:"נועם (2012–)", gender:"M", birth:2012, photo:"https://picsum.photos/seed/n2/300/300", bio:"אוהב רובוטיקה.", parents:["p7","p14"], spouse:null, children:[] },
      { id:"p17", name:"אלה (2010–)", gender:"F", birth:2010, photo:"https://picsum.photos/seed/e2/300/300", bio:"מציירת קומיקס.", parents:["p10","p16"], spouse:null, children:[] },
      { id:"p18", name:"עידו (2014–)", gender:"M", birth:2014, photo:"https://picsum.photos/seed/i1/300/300", bio:"בונה בלגו כמו מקצוען.", parents:["p10","p16"], spouse:null, children:[] },
    ];

    // Helper index
    const byId = Object.fromEntries(familyData.map(p=>[p.id,p]));

    // ==========================
    // Build Cytoscape graph
    // ==========================
    const cy = cytoscape({
      container: document.getElementById('cy'),
      wheelSensitivity: 0.23,
      minZoom: 0.2,
      maxZoom: 2.2,
      style: [
    { selector: 'node[type="person"]', style: {
            'background-color': '#1f2937',
            'border-width': 3,
            'border-color': '#475569',
            'label': 'data(label)',
            'text-valign': 'bottom',
            'text-halign': 'center',
      'text-margin-y': 10,
      'font-size': 14,
            'text-wrap': 'wrap',
            'text-max-width': 110,
            'text-outline-width': 3,
            'text-outline-color': '#0b1220',
            'color': '#e5e7eb',
            'width': 60,
            'height': 60,
            'background-image': 'data(photo)',
            'background-fit': 'cover cover',
            'shape': 'ellipse',
            'overlay-padding': 6
        }},
        { selector: 'node.male', style: { 'border-color': 'var(--male)' }},
        { selector: 'node.female', style: { 'border-color': 'var(--female)' }},

        // Union (marriage) nodes – small diamond connectors
        { selector: 'node[type="union"]', style: {
            'shape': 'diamond', 'background-color': 'var(--union)', 'width': 10, 'height': 10,
            'label': '', 'border-width': 0
        }},

        // Edges
        { selector: 'edge', style: {
            'width': 2, 'line-color': 'var(--edge)', 'curve-style': 'taxi', 'taxi-direction': 'downward', 'taxi-turn-min-distance': 10,
            'target-arrow-shape': 'vee', 'target-arrow-color': 'var(--edge)'
        }},
        { selector: 'edge[rel="spouse"]', style: {
            'line-style': 'dashed', 'target-arrow-shape': 'none', 'curve-style': 'bezier', 'line-color': 'var(--union)'
        }},

    // Path + focus styling
    { selector: 'edge.highlight', style: {
      'line-color': 'var(--highlight)',
      'target-arrow-color': 'var(--highlight)',
      'width': 6,
      'arrow-scale': 1.4,
            'shadow-blur': 12,
            'shadow-color': 'var(--highlight)',
            'shadow-opacity': 0.5,
      'z-index-compare': 'manual',
      'z-index': 999,
      'underlay-color': 'var(--highlight)',
      'underlay-padding': 4,
            'underlay-opacity': 0.25,
            'transition-property': 'line-color, width, arrow-scale, shadow-blur',
            'transition-duration': '200ms'
    }},
    { selector: 'node.highlight', style: {
      'border-color': 'var(--highlight)',
      'border-width': 5,
            'shadow-blur': 10,
            'shadow-color': 'var(--highlight)',
            'shadow-opacity': 0.45,
      'z-index-compare': 'manual',
      'z-index': 1000,
      'underlay-color': 'var(--highlight)',
      'underlay-padding': 6,
            'underlay-opacity': 0.22,
            'transition-property': 'border-color, border-width, shadow-blur',
            'transition-duration': '200ms'
    }},
    { selector: '.dim', style: { 'opacity': 0.15 } }
      ]
    });

    // Build graph elements from our JSON
    function buildGraph(data){
      const elements = [];

      // person nodes
      data.forEach(p=>{
        elements.push({ data:{ id:p.id, type:'person', label:p.name, photo:p.photo }, classes: p.gender==='M'?'male':'female' });
      });

      // marriage/union nodes to make hierarchy neat
      const unions = new Map(); // key: sorted "a|b" -> unionId
      data.forEach(p=>{
        if(p.spouse){
          const a = p.id; const b = p.spouse; if(!byId[b]) return;
          const key = [a,b].sort().join('|');
          if(!unions.has(key)){
            const unionId = 'u_'+key.replace('|','_');
            unions.set(key, unionId);
            elements.push({ data:{ id:unionId, type:'union' } });
            // connect each spouse to union node (dashed edge)
            elements.push({ data:{ id: unionId+'_'+a, source:a, target:unionId, rel:'spouse' } });
            elements.push({ data:{ id: unionId+'_'+b, source:b, target:unionId, rel:'spouse' } });
          }
        }
      });

      // parent -> child via union when possible
      data.forEach(child=>{
        if(child.parents && child.parents.length){
          const [pa,pb] = child.parents;
          if(pa && pb){
            const key = [pa,pb].sort().join('|');
            const unionId = unions.get(key);
            if(unionId){
              elements.push({ data:{ id: unionId+'_'+child.id, source: unionId, target: child.id, rel:'child' } });
            } else {
              // if for some reason no union node, draw from each parent
              if(pa) elements.push({ data:{ id: pa+'_'+child.id, source: pa, target: child.id, rel:'child' } });
              if(pb) elements.push({ data:{ id: pb+'_'+child.id, source: pb, target: child.id, rel:'child' } });
            }
          } else {
            // single parent family
            const pOnly = pa || pb; if(pOnly) elements.push({ data:{ id: pOnly+'_'+child.id, source: pOnly, target: child.id, rel:'child' } });
          }
        }
      });

      cy.add(elements);
    }

    buildGraph(familyData);

    // Layout – hierarchical top (old) to bottom (young)
    function runLayout(){
      cy.layout({ name:'dagre', rankDir:'TB', nodeSep:30, rankSep:60, edgeSep:10 }).run();
    }
    runLayout();

    // Fit initially after a short tick (fonts/images)
    setTimeout(()=> cy.fit(undefined, 30), 200);

    // Populate selects for path highlighting
    function populateSelects(){
      const selA = document.getElementById('personA');
      const selB = document.getElementById('personB');
      const people = familyData.map(p=>({id:p.id, name:p.name}));
      for(const s of [selA, selB]){
        s.innerHTML = '<option value="">בחרו אדם…</option>' + people.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
      }
    }
    populateSelects();

    // Modal logic
    const modal = document.getElementById('personModal');
    const closeModalBtn = document.getElementById('closeModal');
    function openModal(p){
      const nameEl = document.getElementById('modalName');
      const photoEl = document.getElementById('modalPhoto');
      const metaEl = document.getElementById('modalMeta');
      const bioEl = document.getElementById('modalBio');
      const badgesEl = document.getElementById('modalBadges');

      const photoUrl = p.photo || 'https://via.placeholder.com/300x300?text=Photo';
      nameEl.textContent = p.name;
      photoEl.src = photoUrl;

      metaEl.textContent = `${p.gender==='M'?'זכר':'נקבה'} · ${p.birth??''}${p.death? ' – '+p.death: ''}`;
      bioEl.textContent = p.bio || '';

      // Build badges (minimal, מרכזיים בלבד)
      const chips = [];
      const genderColor = p.gender==='M' ? 'var(--male)' : 'var(--female)';
      chips.push(`<span class=\"chip\" style=\"--chip:${genderColor}\">${p.gender==='M'?'זכר':'נקבה'}</span>`);
      const kids = Array.isArray(p.children) ? p.children.length : 0;
      chips.push(`<span class=\"chip\">ילדים: ${kids}</span>`);
      if(p.spouse){
        const sp = byId[p.spouse];
        if(sp) chips.push(`<span class=\"chip\">בן/בת זוג: ${sp.name}</span>`);
      }
      badgesEl.innerHTML = chips.join(' ');

      modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
    }
    function closeModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }
    closeModalBtn.addEventListener('click', closeModal);
    modal.querySelector('.modal-backdrop').addEventListener('click', closeModal);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeModal(); } });

    // Node click -> open info (only for persons)
    cy.on('tap', 'node[type="person"]', evt=>{
      const id = evt.target.id();
      const p = byId[id];
      if(p) openModal(p);
    });

    // Accessible keyboard open (focusable handling)
    cy.on('cxttap', 'node', evt=>{
      // long-press context tap on mobile: center on node
      const n = evt.target; cy.center(n); cy.animate({ center:{ eles:n }, zoom:1.1 }, {duration:200});
    });

    // Path highlighting between two selected people
    function clearHighlights(){
      cy.batch(()=>{
        cy.elements().removeClass('highlight');
        cy.elements().removeClass('dim');
      });
    }

    function highlightPath(aId,bId){
      clearHighlights();
      if(!aId || !bId || aId===bId) return;
      const a = cy.getElementById(aId); const b = cy.getElementById(bId);
      if(!a.nonempty() || !b.nonempty()) return;
      const res = cy.elements().aStar({ root:a, goal:b, directed:false });
      if(res.found){
        cy.batch(()=>{
          res.path.addClass('highlight');
          cy.elements().difference(res.path).addClass('dim');
        });
        cy.fit(res.path, 60);
      }
    }

    document.getElementById('btnPath').addEventListener('click', ()=>{
      const a = document.getElementById('personA').value;
      const b = document.getElementById('personB').value;
      highlightPath(a,b);
    });
    function maybeAutoHighlight(){
      const a = document.getElementById('personA').value;
      const b = document.getElementById('personB').value;
      if(a && b) highlightPath(a,b); else clearHighlights();
    }
    document.getElementById('personA').addEventListener('change', maybeAutoHighlight);
    document.getElementById('personB').addEventListener('change', maybeAutoHighlight);
    document.getElementById('btnClear').addEventListener('click', ()=>{ 
      document.getElementById('personA').value = '';
      document.getElementById('personB').value = '';
      clearHighlights(); 
      cy.fit(undefined, 30); 
    });
    document.getElementById('btnFit').addEventListener('click', ()=> cy.fit(undefined, 30));

    // Resize handling (mobile orientation etc.)
    window.addEventListener('resize', ()=>{ cy.resize(); runLayout(); });

  // ==========================
  // Enhancements – trimmed controls, improved path emphasis
  // ==========================

    // Zoom controls
    function zoomBy(factor){
      const current = cy.zoom();
      const target = Math.max(cy.minZoom(), Math.min(cy.maxZoom(), current * factor));
      cy.animate({ zoom: target, center: { eles: cy.nodes() } }, { duration: 160 });
    }
    document.getElementById('btnZoomIn').addEventListener('click', ()=> zoomBy(1.2));
    document.getElementById('btnZoomOut').addEventListener('click', ()=> zoomBy(1/1.2));

  // (Focus & search features removed per request)
  </script>
</body>
</html>
